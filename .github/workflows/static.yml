name: Deploy static content to Pages

on:
  push:
    branches: ['main']
  workflow_dispatch:

# 1. ê¶Œí•œ ì„¤ì • (ì´ê²Œ ì—†ìœ¼ë©´ í† í°ì´ ìˆì–´ë„ ë¸Œëœì¹˜ ìƒì„±ì„ ëª»í•  ìˆ˜ ìˆìŒ)
permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get commit hash
        id: commit
        run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      # 2. ë°°í¬í•  íŒŒì¼ë“¤ì„ 'build' í´ë” í•œê³³ì— ì˜ˆì˜ê²Œ ëª¨ìœ¼ê¸°
      - name: Prepare Build Directory
        run: |
          mkdir build

          # (A) ë£¨íŠ¸(ìµœì‹  ë²„ì „) íŒŒì¼ ë³µì‚¬
          # .gitê³¼ build í´ë” ìì‹ ì€ ì œì™¸í•˜ê³  ë³µì‚¬
          rsync -av --exclude='.git' --exclude='build' . build/

          # (B) ìŠ¤ëƒ…ìƒ· í´ë” ìƒì„± ë° ë³µì‚¬
          HASH=${{ steps.commit.outputs.hash }}
          mkdir -p build/snapshots/$HASH

          # ë‹¤ì‹œ í•œë²ˆ ìŠ¤ëƒ…ìƒ· í´ë”ë¡œ íŒŒì¼ ë³µì‚¬
          rsync -av --exclude='.git' --exclude='build' . build/snapshots/$HASH/

          echo "ğŸ“‚ Build directory prepared successfully."
          ls -R build

      # 3. ë”± í•œ ë²ˆì˜ ì‹¤í–‰ìœ¼ë¡œ ë°°í¬ ëë‚´ê¸°
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build # ìœ„ì—ì„œ í•©ì¹œ í´ë”ë¥¼ ë°°í¬
          keep_files: true # ì¤‘ìš”: ê³¼ê±°ì— ë§Œë“  ë‹¤ë¥¸ ìŠ¤ëƒ…ìƒ·ë“¤ì„ ì§€ìš°ì§€ ì•ŠìŒ
